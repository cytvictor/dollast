// Generated by LiveScript 1.3.1
(function(){
  var createClass, I, moment, P, ref$, labelField, iconText, iconInput, connect, onGetRound, onAddProbToRound, onRoundModify, log, selector;
  createClass = require('react').createClass;
  I = require('immutable');
  moment = require('moment');
  P = require('prelude-ls');
  ref$ = require('../elements'), labelField = ref$.labelField, iconText = ref$.iconText, iconInput = ref$.iconInput;
  connect = require('react-redux').connect;
  ref$ = require('../../actions'), onGetRound = ref$.onGetRound, onAddProbToRound = ref$.onAddProbToRound, onRoundModify = ref$.onRoundModify;
  log = debug('dollast:component:round:modify');
  selector = function(state, props){
    return {
      round: state.getIn(['db', 'round', props.params.rid, 'get'], I.Map({
        probs: [],
        permit: {
          owner: state.getIn(['session', 'uid']),
          group: 'rounds',
          access: 420
        }
      }))
    };
  };
  module.exports = connect(selector)(createClass({
    displayName: 'rnd-modify',
    componentDidMount: function(){
      var $form;
      if (this.props.params.rid) {
        this.props.dispatch(onGetRound(this.props.params.rid));
      }
      $form = $('#form-round');
      return $form.form({
        on: 'blur',
        onSuccess: this.submit,
        fields: {
          title: {
            identifier: 'title',
            rules: [
              {
                type: 'minLength[4]',
                prompt: 'title has minimum length of 4'
              }, {
                type: 'maxLength[63]',
                prompt: 'title has maximum length of 63'
              }
            ]
          },
          begTime: {
            identifier: 'begTime',
            rules: [{
              type: 'isTime',
              prompt: 'start time should be valid'
            }]
          },
          endTime: {
            identifier: 'endTime',
            rules: [{
              type: 'isTime',
              prompt: 'start time should be valid'
            }]
          },
          owner: {
            identifier: 'owner',
            rules: [{
              type: 'isUserId',
              prompt: 'owner should be valid'
            }]
          },
          group: {
            identifier: 'group',
            rules: [{
              type: 'isUserId',
              prompt: 'group should be valid'
            }]
          },
          access: {
            identifier: 'access',
            rules: [{
              type: 'isAccess',
              prompt: 'access code should be /^[0-7]{3}$/'
            }]
          }
        }
      });
    },
    insertProb: function(pid){
      pid = parseInt(pid);
      if (Number.isInteger(pid)) {
        return this.props.dispatch(onAddProbToRound(pid));
      }
    },
    handleInput: function(evt){
      if (evt.which === 13) {
        this.insertProb(evt.target.value);
        return evt.target.value = '';
      }
    },
    onAddProb: function(){
      var $input;
      $input = $('#pid');
      return this.insertProb($input[0].value);
    },
    updateForms: function(round){
      var $form, ref$, title, begTime, endTime, permit;
      $form = $('#form-round');
      ref$ = round.toJS(), title = ref$.title, begTime = ref$.begTime, endTime = ref$.endTime, permit = ref$.permit;
      if (permit != null && permit.access) {
        permit.access = permit.access.toString(8);
      }
      $form.form('set values', {
        title: title,
        begTime: moment(begTime).format('YYYY-MM-DD hh:mm:ss'),
        endTime: moment(endTime).format('YYYY-MM-DD hh:mm:ss')
      });
      $form.form('set values', permit);
      return log({
        permit: permit
      });
    },
    componentWillUpdate: function(nextProps, nextStates){
      return this.updateForms(nextProps.round);
    },
    submit: function(){
      var $form, values, permit, probs, data;
      $form = $('#form-round');
      values = $form.form('get values');
      permit = {
        owner: values.owner,
        group: values.group,
        access: values.access
      };
      permit.access = parseInt(permit.access, 8);
      probs = this.props.round.get('probs').toJS();
      probs = P.map(function(it){
        return it._id;
      }, probs);
      data = Object.assign({
        title: values.title,
        begTime: values.begTime,
        endTime: values.endTime
      }, {
        rid: this.rid,
        probs: probs,
        permit: permit
      });
      return this.props.dispatch(onRoundModify(data));
    },
    render: function(){
      var round, title, prob;
      round = this.props.round.toJS();
      this.rid = this.props.params.rid;
      if (this.rid) {
        title = "Round " + this.rid;
      } else {
        title = "Create new round";
        this.rid = 0;
      }
      return _('div', {
        className: "ui form segment",
        id: 'form-round'
      }, _('h1', {
        className: "ui header dividing"
      }, title), _('div', {
        className: "ui error message"
      }), _('h2', {
        className: "ui dividing header"
      }, 'configuration'), _('div', {
        className: "ui fields three"
      }, _(labelField, {
        text: 'title'
      }, _('div', {
        className: "ui input"
      }, _('input', {
        name: 'title'
      }))), _(labelField, {
        text: "start from"
      }, _('div', {
        className: "ui input"
      }, _('input', {
        name: 'begTime',
        placeholder: "YYYY-MM-DD HH:mm:ss"
      }))), _(labelField, {
        text: "end at"
      }, _('div', {
        className: "ui input"
      }, _('input', {
        name: 'endTime',
        placeholder: "YYYY-MM-DD HH:mm:ss"
      })))), _('h2', {
        className: "ui header dividing"
      }, 'permission'), _('div', {
        className: "ui three fields"
      }, _(labelField, {
        text: 'owner'
      }, _('div', {
        className: "ui input"
      }, _('input', {
        name: 'owner',
        type: 'string'
      }))), _(labelField, {
        text: 'group'
      }, _('div', {
        className: "ui input"
      }, _('input', {
        name: 'group',
        type: 'string'
      }))), _(labelField, {
        text: 'access'
      }, _('div', {
        className: "ui input"
      }, _('input', {
        name: 'access',
        type: 'string'
      })))), _('h2', {
        className: "ui header dividing"
      }, 'problemset'), _('div', {
        className: "ui two fields"
      }, _('div', {
        className: "field"
      }, _('table', {
        className: "ui table segment definition"
      }, _('thead', null, _('tr', null, _('th', {
        className: 'collapsing'
      }, ""), _('th', null, 'pid'))), _('tbody', null, (function(){
        var i$, ref$, len$, results$ = [];
        for (i$ = 0, len$ = (ref$ = round.probs).length; i$ < len$; ++i$) {
          prob = ref$[i$];
          results$.push(_('tr', {
            key: prob._id
          }, _('td', null, _('div', {
            className: "ui icon button"
          }, _('i', {
            className: "icon mini remove"
          }))), _('td', null, prob._id + ". " + prob.outlook.title)));
        }
        return results$;
      }())), _('tfoot', null, _('tr', null, _('th', null, ""), _('th', null, _('div', {
        className: "ui input action"
      }, _('input', {
        name: 'pid',
        id: 'pid',
        onChange: this.handleInput
      }), _(iconText, {
        className: "floated right",
        icon: "chevron right",
        text: 'add',
        onClick: this.onAddProb
      })))))))), _('div', {
        className: "ui field"
      }, _(iconText, {
        className: "floated red",
        text: 'delete',
        icon: 'delete',
        onClick: this['delete']
      }), _(iconText, {
        className: "floated secondary",
        text: 'cancel',
        icon: 'undo'
      }), _(iconText, {
        className: "floated primary submit",
        text: 'save',
        icon: 'save'
      })));
    }
  }));
}).call(this);

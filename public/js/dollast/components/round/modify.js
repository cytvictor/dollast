// Generated by LiveScript 1.3.1
(function(){
  var createClass, I, moment, P, ref$, labelField, iconText, iconInput, connect, onGetRound, onAddProbToRound, onRoundModify, log, selector;
  createClass = require('react').createClass;
  I = require('immutable');
  moment = require('moment');
  P = require('prelude-ls');
  ref$ = require('../elements'), labelField = ref$.labelField, iconText = ref$.iconText, iconInput = ref$.iconInput;
  connect = require('react-redux').connect;
  ref$ = require('../../actions'), onGetRound = ref$.onGetRound, onAddProbToRound = ref$.onAddProbToRound, onRoundModify = ref$.onRoundModify;
  log = debug('dollast:component:round:modify');
  selector = function(state){
    return {
      round: state.getIn(['round', 'update'], I.Map({
        probs: []
      }))
    };
  };
  module.exports = connect(selector)(createClass({
    displayName: 'rnd-modify',
    componentWillMount: function(){
      if (this.props.params.rid) {
        return this.props.dispatch(onGetRound(this.props.params.rid, 'update', 'total'));
      }
    },
    componentDidMount: function(){
      var $form;
      $form = $('#form-round');
      return $form.form({
        on: 'blur',
        fields: {
          title: {
            identifier: 'title',
            rules: [
              {
                type: 'minLength[4]',
                prompt: 'title has minimum length of 4'
              }, {
                type: 'maxLength[63]',
                prompt: 'title has maximum length of 63'
              }
            ]
          },
          begTime: {
            identifier: 'begTime',
            rules: [{
              type: 'isTime',
              prompt: 'start time should be valid'
            }]
          },
          endTime: {
            identifier: 'endTime',
            rules: [{
              type: 'isTime',
              prompt: 'start time should be valid'
            }]
          }
        }
      });
    },
    insertProb: function(pid){
      pid = parseInt(pid);
      if (Number.isInteger(pid)) {
        return this.props.dispatch(onAddProbToRound(pid));
      }
    },
    handleInput: function(evt){
      if (evt.which === 13) {
        this.insertProb(evt.target.value);
        return evt.target.value = '';
      }
    },
    onAddProb: function(){
      var $input;
      $input = $('#pid');
      return this.insertProb($input[0].value);
    },
    submit: function(){
      var $form, ref$, title, begTime, endTime, probs;
      $form = $('#form-round');
      ref$ = $form.form('get values'), title = ref$.title, begTime = ref$.begTime, endTime = ref$.endTime;
      probs = this.props.round.get('probs').toJS();
      probs = P.map(function(it){
        return it._id;
      }, probs);
      log({
        probs: probs
      });
      return this.props.dispatch(onRoundModify({
        rid: this.rid,
        title: title,
        begTime: begTime,
        endTime: endTime,
        probs: probs
      }));
    },
    render: function(){
      var round, title, prob;
      round = this.props.round.toJS();
      this.rid = this.props.params.rid;
      if (this.rid) {
        title = "Round " + rid;
      } else {
        title = "Create new round";
        this.rid = 0;
      }
      return _('div', {
        className: "ui form segment",
        id: 'form-round'
      }, _('h1', {
        className: "ui header dividing"
      }, title), _('div', {
        className: "ui fields three"
      }, _(labelField, {
        text: 'title'
      }, _('div', {
        className: "ui input"
      }, _('input', {
        name: 'title'
      }))), _(labelField, {
        text: "start from"
      }, _('div', {
        className: "ui input"
      }, _('input', {
        name: 'begTime',
        placeholder: "YYYY-MM-DD HH:mm:ss"
      }))), _(labelField, {
        text: "end at"
      }, _('div', {
        className: "ui input"
      }, _('input', {
        name: 'endTime',
        placeholder: "YYYY-MM-DD HH:mm:ss"
      })))), _('h2', {
        className: "ui header dividing"
      }, 'problemset'), _('div', {
        className: "ui two fields"
      }, _('div', {
        className: "field"
      }, _('table', {
        className: "ui table segment definition"
      }, _('thead', null, _('tr', null, _('th', {
        className: 'collapsing'
      }, ""), _('th', null, 'pid'))), _('tbody', null, (function(){
        var i$, ref$, len$, results$ = [];
        for (i$ = 0, len$ = (ref$ = round.probs).length; i$ < len$; ++i$) {
          prob = ref$[i$];
          results$.push(_('tr', {
            key: prob._id
          }, _('td', null, _('div', {
            className: "ui icon button"
          }, _('i', {
            className: "icon mini remove"
          }))), _('td', null, prob._id + ". " + prob.outlook.title)));
        }
        return results$;
      }())), _('tfoot', null, _('tr', null, _('th', null, ""), _('th', null, _('div', {
        className: "ui input action"
      }, _('input', {
        name: 'pid',
        id: 'pid',
        onChange: this.handleInput
      }), _(iconText, {
        className: "floated right",
        icon: "chevron right",
        text: 'add',
        onClick: this.onAddProb
      })))))))), _('div', {
        className: 'field'
      }, _(iconText, {
        className: "floated right red",
        text: 'delete',
        icon: 'delete',
        onClick: this['delete']
      }), _(iconText, {
        className: "floated right secondary",
        text: 'cancel',
        icon: 'cancel'
      }), _(iconText, {
        className: "floated right primary submit",
        text: 'save',
        icon: 'save',
        onClick: this.submit
      })));
    }
  }));
}).call(this);

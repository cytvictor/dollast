// Generated by LiveScript 1.3.1
var koa, koaJson, koaStatic, koaBodyparser, koaGenericSession, koaValidate, koaRouter, koaSend, koaJwt, util, path, fs, debug, config, db, app, log, routers, out$ = typeof exports != 'undefined' && exports || this;
koa = require('koa');
koaJson = require('koa-json');
koaStatic = require('koa-static');
koaBodyparser = require('koa-bodyparser');
koaGenericSession = require('koa-generic-session');
koaValidate = require('koa-validate');
koaRouter = require('koa-router');
koaSend = require('koa-send');
koaJwt = require('koa-jwt');
util = require('util');
path = require('path');
fs = require('fs');
debug = require('debug');
config = require('./config');
db = require('./db');
out$.app = app = koa();
log = debug('dollast:server');
if (!db) {
  logger.fatal("No Database found");
}
app.use(koaBodyparser({
  extendTypes: {
    json: ['application/x-javascript'],
    multipart: ['multipart/form-data']
  }
}));
app.use(function*(next){
  console.log(this.req.method + " " + this.req.url);
  yield next;
});
app.keys = config.keys;
app.use(koaGenericSession({
  cookie: {
    maxAge: 1000 * 60 * 5
  }
}));
app.use(koaJson());
app.use(function*(next){
  var ref$, i$, len$, folders;
  db.bindCtx(this);
  (ref$ = this.session).theme || (ref$.theme = config['default'].theme);
  (ref$ = this.session).priv || (ref$.priv = config['default'].priv);
  if ((ref$ = this.method) === 'HEAD' || ref$ === 'GET') {
    for (i$ = 0, len$ = (ref$ = ["public", "theme/" + this.session.theme]).length; i$ < len$; ++i$) {
      folders = ref$[i$];
      if (yield koaSend(this, this.path, {
        index: 'index.html',
        root: path.resolve(folders)
      })) {
        return;
      }
    }
  }
  yield next;
});
routers = require('./routers');
app.use(koaJwt({
  secret: config.secret,
  passthrough: true
}));
app.use(function*(next){
  log("request", this.request.body, "jwt", this.user, "query", this.query);
  yield next;
});
app.use(routers.router);
console.log("Listening port 3000");
app.listen(3000);
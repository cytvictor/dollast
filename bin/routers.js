// Generated by LiveScript 1.3.1
var koaRouter, debug, util, path, coBusboy, bluebird, config, core, tmp, db, log, dataCtrl, probCtrl, solCtrl, rndCtrl, siteCtrl, userCtrl, paramsValidator, regPriv, router, privateRouter, out$ = typeof exports != 'undefined' && exports || this;
koaRouter = require('koa-router');
debug = require('debug');
util = require('util');
path = require('path');
coBusboy = require('co-busboy');
bluebird = require('bluebird');
config = require('./config');
core = require('./core');
tmp = bluebird.promisifyAll(require('tmp'));
db = config.db;
log = debug('router');
dataCtrl = {
  upload: function*(){
    var pid, parts, part;
    pid = this.params.pid;
    parts = coBusboy(this, {
      autoFields: true
    });
    while (part = yield parts) {
      this.body = yield core.upload(pid, part);
    }
    yield db.prob.updData(pid);
  },
  'delete': function*(){
    throw Error('unimplemented');
  },
  show: function*(){
    var data;
    data = yield db.prob.listDataset(this.params.pid);
    this.body = data;
  }
};
probCtrl = {
  list: function*(){
    this.body = yield db.prob.list();
    log("prob-list " + this.body);
  },
  nextCount: function*(){
    this.body = {
      _id: yield db.prob.nextCount()
    };
  },
  show: function*(){
    this.body = yield db.prob.show(this.params.pid, {
      mode: "view"
    });
    console.log("body: " + util.inspect(this.body));
  },
  total: function*(){
    this.body = yield db.prob.show(this.params.pid, {
      mode: "total"
    });
  },
  save: function*(){
    this.body = yield db.prob.modify(this.params.pid, this.request.body);
  },
  'delete': function*(){
    throw Error('unimplemented');
  }
};
solCtrl = {
  submit: function*(){
    var uid, ref$;
    uid == null && (uid = (ref$ = this.session.passport.user) != null ? ref$._id : void 8);
    this.body = {
      status: yield db.sol.submit(this.request.body, uid)
    };
  },
  list: function*(){
    this.body = yield db.sol.list();
  },
  show: function*(){
    this.body = yield db.sol.show(this.params.sid);
  }
};
rndCtrl = {
  list: function*(){
    this.body = yield db.rnd.list();
  },
  nextCount: function*(){
    this.body = {
      _id: yield db.rnd.nextCount()
    };
  },
  show: function*(){
    this.body = yield db.rnd.show(this.params.rid, {
      mode: "view"
    });
  },
  save: function*(){
    this.body = {
      status: yield db.rnd.modify(this.params.rid, this.request.body)
    };
  },
  total: function*(){
    this.body = yield db.rnd.show(this.params.rid, {
      mode: "total"
    });
  },
  'delete': function*(){
    this.body = {
      status: yield db.rnd['delete'](this.params.rid)
    };
  }
};
siteCtrl = {
  theme: function*(){
    this.session.theme = this.params.theme;
    this.body = {
      status: true
    };
  },
  loginToken: function*(){
    throw Error('unimplemented');
    this.body = this.session.loginToken = 1;
  },
  session: function*(){
    var that, ref$, ref1$;
    log(this.session);
    this.body = {
      uid: (that = (ref$ = this.session.passport) != null ? (ref1$ = ref$.user) != null ? ref1$._id : void 8 : void 8) != null ? that : void 8
    };
  }
};
userCtrl = {
  show: function*(){
    this.body = yield db.user.show(this.params.uid);
  },
  save: function*(){
    this.body = {
      status: yield db.user.modify(this.request.body)
    };
  },
  register: function*(){
    this.body = {
      status: yield db.user.register(this.request.body)
    };
  }
};
paramsValidator = {
  pid: function*(pid, next){
    this.params.pid = parseInt(pid);
    yield next;
  },
  sid: function*(sid, next){
    this.params.sid = parseInt(sid);
    yield next;
  },
  rid: function*(rid, next){
    this.params.rid = parseInt(rid);
    yield next;
  }
};
regPriv = function(acquiredPriv, func){
  return (function(){
    var checkPrivilege;
    checkPrivilege = function*(priv){
      var i$, ref$, len$, user;
      for (i$ = 0, len$ = (ref$ = _.words(this.session.passport.privList)).length; i$ < len$; ++i$) {
        priv = ref$[i$];
        if (priv === "login" && !this.session.passport.user) {
          return false;
        } else {
          if (!user) {
            user = yield db.user.model.findById(user, "priv-list");
          }
          if (!user.queryPriv(priv)) {
            return false;
          }
        }
      }
      return true;
    };
    return function*(next){
      if (false) {
        this.body = {
          status: "privilege acquired"
        };
      } else {
        yield func.call(this);
      }
    };
  }.call(this));
};
router = new koaRouter();
router.param('pid', paramsValidator.pid).param('sid', paramsValidator.sid).param('rid', paramsValidator.rid).get('/problem', regPriv('login', probCtrl.list)).get('/problem/next-count', regPriv('prob-all', probCtrl.nextCount)).get('/problem/:pid', regPriv('login', probCtrl.show)).get('/problem/:pid/total', regPriv('prob-all', probCtrl.total)).post('/problem/:pid', regPriv('prob-all', probCtrl.save))['delete']('/problem/:pid', regPriv('prob-all', probCtrl['delete'])).get('/data/:pid', regPriv('prob-all', dataCtrl.show)).post('/data/:pid/upload', regPriv('prob-all', dataCtrl.upload)).post('/solution/submit', regPriv('login', solCtrl.submit)).get('/solution', regPriv('', solCtrl.list)).get('/solution/:sid', regPriv('sol-all', solCtrl.show)).get('/round', regPriv('login', rndCtrl.list)).get('/round/next-count', regPriv('rnd-all', rndCtrl.nextCount)).get('/round/:rid', regPriv('login', rndCtrl.show)).post('/round/:rid', regPriv('rnd-all', rndCtrl.save)).get('/round/:rid/total', regPriv('rnd-all', rndCtrl.total))['delete']('/round/:rid', regPriv('rnd-all', rndCtrl['delete'])).get('/site/theme/:theme', regPriv('login', siteCtrl.theme)).get('/site/session', regPriv('', siteCtrl.session)).get('/site/session/login-token', regPriv('', siteCtrl.loginToken)).get('/user/:uid/profile', regPriv('', userCtrl.show)).post('/user/register/', regPriv('', userCtrl.register)).post('/user/:uid/modify', regPriv('', userCtrl.save));
out$.privateRouter = privateRouter = router.middleware();
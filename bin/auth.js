// Generated by LiveScript 1.3.1
var koaPassport, passportLocal, debug, util, _, co, db, log, LocalStrategy;
koaPassport = require('koa-passport');
passportLocal = require('passport-local');
debug = require('debug');
util = require('util');
_ = require('prelude-ls');
co = require('co');
db = require('./db');
log = debug("auth");
LocalStrategy = passportLocal.Strategy;
koaPassport.serializeUser(function*(user, done){
  var privList, i;
  log("user " + util.inspect(user) + " done");
  privList = (yield db.user.model.findById(user.user, "priv-list")).privList;
  privList.push('login');
  user.privList = _.pairsToObj(privList, (function(){
    var i$, to$, results$ = [];
    for (i$ = 1, to$ = privList.length; i$ <= to$; ++i$) {
      i = i$;
      results$.push(true);
    }
    return results$;
  }()));
  done(null, user);
});
koaPassport.deserializeUser(function(id, done){
  console.log("deserialize! " + id);
  return db.user.model.findById(id, function(err, user){
    return done(err, user);
  });
});
koaPassport.use(new LocalStrategy(function(uid, pswd, done){
  console.log("Login: " + uid + " " + pswd + " " + util.inspect(this));
  return db.user.query(uid, pswd, done);
}));